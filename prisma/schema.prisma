generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model RefreshToken {
  id          String  @id @unique @default(uuid())
  hashedToken String  @db.Text
  revoked     Boolean @default(false)

  userId Int
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  id      String           @id @unique @default(cuid())
  revoked Boolean          @default(false)
  type    VerificationType @default(EMAIL_VERIFICATION)

  userId Int
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model User {
  id           Int       @id @default(autoincrement())
  name         String
  email        String    @unique
  profileImage String?
  gender       Gender    @default(MALE)
  isVerified   Boolean   @default(false)
  password     String    @db.Text
  phoneNumber  String
  category     Category  @default(INTERNAL)
  otpHash      String?   @db.Text
  otpExpiresAt DateTime?

  collegeId Int     @default(1)
  College   College @relation(fields: [collegeId], references: [id], onDelete: Cascade)

  BranchRep BranchRep?

  Alumni    Alumni?
  UserRoles UserRole[]

  CommitteeMembership CommitteeMembership?
  HeadOfCommittee     Committee[]          @relation("CommitteeHeadUser")
  CoHeadOfCommittee   Committee[]          @relation("CommitteeCoHeadUser")

  Judges        Judge[]
  ScoresGiven   Scores[]
  CommentsGiven Comments[]
  Organisers    Organiser[]

  PaymentOrders     PaymentOrder[]
  RefreshTokens     RefreshToken[]
  CertificateIssue  CertificateIssue[]
  VerificationToken VerificationToken[]
  PronitePass       PronitePass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  PID         PID?
  WebLog      WebLog[]
  documents   Document[]
  teamMembers TeamMember[]

  AccommodationPayment AccommodationPayment[]
  AccommodationBooking AccommodationBooking[]
  documentUserAccesses DocumentUserAccess[]
  sessions             Session[]

  @@index([collegeId])
  @@index([id])
}

model UserRole {
  id   Int  @id @default(autoincrement())
  role Role

  userId Int
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, role])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  userId    Int
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userAgent String?
  ip        String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Alumni {
  id               Int    @id @default(autoincrement())
  yearOfGraduation Int
  idDocument       String @db.Text

  userId Int  @unique
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model College {
  id                 Int                  @id @default(autoincrement())
  name               String
  details            String?
  ChampionshipPoints ChampionshipPoints[]
  type               CollegeType          @default(ENGINEERING)

  Users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Variable {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Branch {
  id      Int     @id @default(autoincrement())
  name    String
  details String?

  BranchReps BranchRep[]
  Event      Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Committee {
  id           Int           @id @default(autoincrement())
  name         CommitteeName @unique
  headUserId   Int?
  coHeadUserId Int?

  headUser   User? @relation("CommitteeHeadUser", fields: [headUserId], references: [id], onDelete: SetNull)
  coHeadUser User? @relation("CommitteeCoHeadUser", fields: [coHeadUserId], references: [id], onDelete: SetNull)

  Members         CommitteeMembership[]
  documentDetails DocumentDetails[]
  documentAccess  DocumentAccess[]

  // Access Control
  canCreateDocuments  Boolean @default(false)
  canCreateClassified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommitteeMembership {
  id     Int                       @id @default(autoincrement())
  status CommitteeMembershipStatus @default(PENDING)
  photo  String?

  userId Int  @unique
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  committeeId Int
  Committee   Committee @relation(fields: [committeeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([committeeId, userId])
  @@index([committeeId, status])
}

model Event {
  id          Int           @id @default(autoincrement())
  name        String
  description String?       @db.Text
  image       String?
  fees        Int           @default(0)
  venue       String?
  minTeamSize Int           @default(1)
  maxTeamSize Int           @default(1)
  maxTeams    Int?
  published   Boolean       @default(false)
  eventType   EventType     @default(INDIVIDUAL)
  category    EventCategory @default(TECHNICAL)
  tier        EventTier     @default(GOLD)
  isBranch    Boolean       @default(true)
  isStarted   Boolean       @default(false)
  branchId    Int?
  Branch      Branch?       @relation(fields: [branchId], references: [id], onDelete: Restrict)

  day DayType[] @default([Day1])

  Teams Team[]

  Rounds             Round[]
  Winner             Winners[]
  Organisers         Organiser[]
  CertificateIssue   CertificateIssue[]
  ChampionshipPoints ChampionshipPoints[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId])
}

model Team {
  id        Int     @id @default(autoincrement())
  name      String
  roundNo   Int     @default(1)
  confirmed Boolean @default(false)
  attended  Boolean @default(false)
  leaderId  Int?
  Leader    PID?    @relation("TeamLeader", fields: [leaderId], references: [id], onDelete: SetNull)

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  Winner Winners?

  Score             Scores[]
  Comments          Comments[]
  QuizScores        QuizScore[]
  TeamMembers       TeamMember[]
  QuizSubmissions   QuizSubmission[]
  EventPaymentOrder EventPaymentOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, eventId])
  @@index([eventId, roundNo])
  @@index([leaderId])
}

model Round {
  roundNo     Int       @default(1)
  isCompleted Boolean   @default(false)
  date        DateTime?

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  quizId String?
  Quiz   Quiz?

  Judges   Judge[]
  Comments Comments[]
  Criteria Criteria[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([eventId, roundNo])
  @@unique([eventId, roundNo])
  @@index([quizId])
}

model PaymentOrder {
  id              String      @id @default(cuid())
  orderId         String      @unique
  amount          Int         @default(0)
  collectedAmount Int         @default(0)
  paymentDataJson Json?
  paymentData     Payment?
  status          Status      @default(PENDING)
  type            PaymentType @default(FEST_REGISTRATION)
  receipt         String?
  userId          Int
  User            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  PID       PID?

  @@index([userId])
}

model EventPaymentOrder {
  id          String @id @default(cuid())
  orderId     String @unique
  amount      Int    @default(250)
  paymentData Json?
  status      Status @default(PENDING)

  teamId Int
  Team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
}

model BranchRep {
  id Int @id @default(autoincrement())

  userId Int  @unique
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  branchId Int
  Branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, branchId])
  @@index([branchId, userId])
}

model Organiser {
  id Int @id @default(autoincrement())

  userId Int
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  name        String?
  phoneNumber String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, eventId])
  @@index([eventId, userId])
}

model WebLog {
  id        Int      @id @default(autoincrement())
  message   String   @db.Text
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
}

model TeamMember {
  id Int @id @default(autoincrement())

  pidId Int
  PID   PID @relation(fields: [pidId], references: [id], onDelete: Cascade)

  teamId Int
  Team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    Int?

  @@unique([pidId, teamId])
  @@index([teamId, pidId])
}

model Judge {
  id Int @id @default(autoincrement())

  userId Int
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId Int
  roundNo Int
  Round   Round @relation(fields: [eventId, roundNo], references: [eventId, roundNo], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, eventId, roundNo])
  @@index([eventId, roundNo, userId])
}

model Criteria {
  id         Int    @id @default(autoincrement())
  name       String
  scoreOutOf Int    @default(10)

  eventId Int
  roundNo Int
  Round   Round @relation(fields: [eventId, roundNo], references: [eventId, roundNo], onDelete: Cascade)

  Score Scores[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId, roundNo])
}

model Scores {
  id Int @id @default(autoincrement())

  score String

  teamId Int
  Team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  criteriaId Int
  Criteria   Criteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)

  judgeId Int
  Judge   User @relation(fields: [judgeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, criteriaId, judgeId])
  @@index([teamId, criteriaId])
  @@index([criteriaId])
  @@index([judgeId])
}

model Comments {
  id Int @id @default(autoincrement())

  comment String

  teamId Int
  Team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  eventId Int
  roundNo Int
  Round   Round @relation(fields: [eventId, roundNo], references: [eventId, roundNo], onDelete: Cascade)

  judgeId Int
  Judge   User @relation(fields: [judgeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, eventId, roundNo, judgeId])
  @@index([teamId])
  @@index([eventId, roundNo])
  @@index([judgeId])
}

model Winners {
  id Int @id @default(autoincrement())

  type WinnerType

  teamId Int?  @unique
  Team   Team? @relation(fields: [teamId], references: [id], onDelete: Cascade)

  pidId Int? @unique
  PID   PID? @relation(fields: [pidId], references: [id], onDelete: Cascade)

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, type])
  @@index([teamId])
  @@index([pidId])
  @@index([eventId])
}

model PronitePass {
  id Int @id @default(autoincrement())

  proniteDay ProniteDay

  userId Int
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, proniteDay])
  @@index([userId])
}

model CertificateIssue {
  id Int @id @default(autoincrement())

  issued Boolean @default(false)

  userId Int
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
}

model Options {
  id String @id @default(cuid())

  value    String  @db.Text
  isAnswer Boolean @default(false)

  questionId String
  Question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  Submissions QuizSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([questionId])
}

model QuizSubmission {
  id String @id @default(cuid())

  teamId Int
  Team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  optionId String
  Options  Options @relation(fields: [optionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([optionId])
}

model QuizScore {
  id String @id @default(cuid())

  score     Int     @default(0)
  timeTaken Float
  flags     Int     @default(0)
  allowUser Boolean @default(true)

  teamId Int
  Team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  quizId String
  Quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  attemptStartTime DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, quizId])
  @@index([quizId])
  @@index([teamId])
}

model Quiz {
  id String @id @default(cuid())

  name             String
  description      String?  @db.Text
  startTime        DateTime
  endTime          DateTime
  allowAttempts    Boolean  @default(false)
  points           Int      @default(1)
  qualifyNext      Int      @default(5)
  password         String
  completed        Boolean  @default(false)
  overridePassword String

  roundId Int
  eventId Int
  Round   Round @relation(fields: [eventId, roundId], references: [eventId, roundNo], onDelete: Cascade)

  Questions  Question[]
  QuizScores QuizScore[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, roundId])
  @@index([roundId])
}

model Question {
  id String @id @default(cuid())

  question    String  @db.Text
  description String? @db.Text
  isCode      Boolean @default(false)
  image       String?

  quizId String
  Quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  options Options[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([quizId])
}

enum Gender {
  MALE
  FEMALE
}

enum AccommodationBookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum ProniteDay {
  Day1
  Day2
}

enum PaymentType {
  FEST_REGISTRATION
  EVENT_REGISTRATION
  ACC_REGISTRATION
}

enum Role {
  USER
  ADMIN
  JURY
  DOCUMENTATION
  ACCOMMODATION
}

enum Status {
  PENDING
  SUCCESS
  FAILED
}

enum VerificationType {
  RESET_PASSWORD
  EMAIL_VERIFICATION
}

enum EventType {
  INDIVIDUAL
  TEAM
  INDIVIDUAL_MULTIPLE_ENTRY
  TEAM_MULTIPLE_ENTRY
}

enum EventCategory {
  TECHNICAL
  NON_TECHNICAL
  CORE
  SPECIAL
}

enum EventTier {
  DIAMOND
  GOLD
  SILVER
  BRONZE
}

enum CommitteeName {
  MEDIA
  SOCIAL_MEDIA
  THORANA
  EVENT_MANAGEMENT
  ACCOMMODATION
  DIGITAL
  INAUGURAL
  CREW
  HOUSE_KEEPING
  FOOD
  TRANSPORT
  PUBLICITY
  DOCUMENTATION
  FINANCE
  CULTURAL
  REQUIREMENTS
  DISCIPLINARY
  TECHNICAL
  JURY
}

enum CommitteeMembershipStatus {
  PENDING
  APPROVED
}

enum CollegeType {
  ENGINEERING
  NON_ENGINEERING
  OTHER
}

enum WinnerType {
  WINNER
  RUNNER_UP
  SECOND_RUNNER_UP
}

enum DayType {
  Day1
  Day2
  Day3
  Day4
}

enum Category {
  INTERNAL
  EXTERNAL
  ALUMNI
}

model PID {
  id      Int    @id @default(autoincrement())
  pidCode String @unique

  userId Int  @unique
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  paymentOrderId String       @unique
  PaymentOrder   PaymentOrder @relation(fields: [paymentOrderId], references: [orderId], onDelete: Cascade)

  AccommodationPayment AccommodationPayment[]
  ChampionshipPoints   ChampionshipPoints[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  TeamMembers TeamMember[]
  LedTeams    Team[]       @relation("TeamLeader")
  winners     Winners?

  @@index([userId])
  @@index([pidCode])
}

model PriorUser {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  name        String?
  phoneNumber String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ServerVariable {
  key       String   @id
  value     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DocumentDetails {
  id          Int     @id @default(autoincrement())
  title       String
  description String  @db.Text
  requestedBy String?

  committee   Committee @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  committeeId Int

  isClassified   Boolean          @default(false)
  documentAccess DocumentAccess[]

  Documents Document[]

  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  documentUserAccesses DocumentUserAccess[]

  @@index([committeeId])
}

model DocumentAccess {
  id          Int        @id @default(autoincrement())
  documentId  Int
  committeeId Int
  accessType  AccessType

  document  DocumentDetails @relation(fields: [documentId], references: [id], onDelete: Cascade)
  committee Committee       @relation(fields: [committeeId], references: [id], onDelete: Cascade)

  @@unique([documentId, committeeId])
  @@index([committeeId])
  @@index([documentId])
}

model DocumentUserAccess {
  id         Int @id @default(autoincrement())
  documentId Int
  userId     Int

  document DocumentDetails @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([documentId, userId])
  @@index([documentId])
  @@index([userId])
}

model ChampionshipPoints {
  id String @id @default(cuid())

  points Int @default(0)

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  winnerType WinnerType

  pidId Int
  PID   PID @relation(fields: [pidId], references: [id], onDelete: Cascade)

  collegeId Int
  College   College @relation(fields: [collegeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
  @@index([pidId])
  @@index([collegeId])
}

enum AccessType {
  HEAD_ONLY
  HEAD_AND_COHEAD
}

model Document {
  id           Int    @id @default(autoincrement())
  documentCode String @unique
  fileUrl      String

  docDetails   DocumentDetails @relation(fields: [docDetailsId], references: [id], onDelete: Cascade)
  docDetailsId Int

  generatedBy   User @relation(fields: [generatedById], references: [id], onDelete: Cascade)
  generatedById Int

  version   Int @default(1)
  pageCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([docDetailsId])
  @@index([generatedById])
}

model AccommodationPayment {
  id          String      @id @default(cuid())
  orderId     String      @unique
  amount      Int         @default(200)
  paymentData Json?
  status      Status      @default(PENDING)
  type        PaymentType @default(ACC_REGISTRATION)

  userId Int
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  pidId Int?
  PID   PID? @relation(fields: [pidId], references: [id], onDelete: SetNull)

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  accommodationBookings AccommodationBooking[]

  @@index([userId])
}

model AccommodationBooking {
  id                String                     @id @default(cuid())
  accommodationType Gender
  checkIn           DateTime
  checkOut          DateTime
  idCard            String?
  receipt           String?
  status            AccommodationBookingStatus @default(PENDING)

  userId Int
  User   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  paymentId String?
  Payment   AccommodationPayment? @relation(fields: [paymentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model AccommodationRequests {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PaymentStatus {
  CREATED
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  NETBANKING
  UPI
  WALLET
  EMI
}

enum PaymentPurpose {
  FEST_REGISTRATION
  EVENT_REGISTRATION
  MERCH
  ACCOMMODATION
}

model Payment {
  id String @id @default(cuid())

  // Gateway identifiers
  gatewayPaymentId String  @unique
  gatewayOrderId   String? @unique
  entity           String?

  // Amounts (paise)
  amount         Int
  fee            Int?
  tax            Int?
  amountRefunded Int    @default(0)
  currency       String @default("INR")

  // Status
  status        PaymentStatus
  captured      Boolean       @default(false)
  refundStatus  String?
  international Boolean       @default(false)

  // Method
  method   PaymentMethod
  bankCode String?
  wallet   String?
  vpa      String?
  cardId   String?

  // Acquirer
  bankTransactionId String?

  // User info
  email   String?
  contact String?

  // Purpose mapping
  purpose        PaymentPurpose
  registrationId String?
  userId         String?

  // Errors
  errorCode        String?
  errorReason      String?
  errorSource      String?
  errorStep        String?
  errorDescription String?

  // Timestamps
  createdAt DateTime
  updatedAt DateTime @updatedAt

  PaymentOrder PaymentOrder? @relation(fields: [gatewayOrderId], references: [orderId])

  @@index([userId])
  @@index([registrationId])
  @@index([gatewayOrderId])
}

model DocumentationSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
